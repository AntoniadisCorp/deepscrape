# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on merge
on:
  push:
    branches:
      - main
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: "20"
      - name: Get npm cache directory
        id: npm-cache-dir
        run: |
          echo "::set-output name=dir::$(npm config get cache)"
      - uses: actions/cache@v3
        id: npm-cache
        with:
          path: ${{ steps.npm-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      - name: Install Dependencies
        run: npm ci
      # Debugging step to check environment variables
      - name: Debug Environment Variables
        run: |
          echo "API_KEY=$API_KEY"
          echo "AUTH_DOMAIN=$AUTH_DOMAIN"
          echo "DATABASE_URL=$DATABASE_URL"
          echo "PROJECT_ID=$PROJECT_ID"
          echo "STORAGE_BUCKET=$STORAGE_BUCKET"
          echo "MESSAGING_SENDER_ID=$MESSAGING_SENDER_ID"
          echo "APP_ID=$APP_ID"
          echo "RECAPTCHA_KEY=$RECAPTCHA_KEY"
          echo "ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY"
          echo "CRAWL4AI_API_KEY=$CRAWL4AI_API_KEY"
          echo "OPENAI_API_KEY=$OPENAI_API_KEY"
          echo "GROQ_API_KEY=$GROQ_API_KEY"
          echo "GOOGLE_API_KEY=$GOOGLE_API_KEY"
          echo "JINAAI_API_KEY=$JINAAI_API_KEY"
        env:
          API_KEY: ${{ secrets.API_KEY }}
          AUTH_DOMAIN: ${{ secrets.AUTH_DOMAIN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          STORAGE_BUCKET: ${{ secrets.STORAGE_BUCKET }}
          MESSAGING_SENDER_ID: ${{ secrets.MESSAGING_SENDER_ID }}
          APP_ID: ${{ secrets.APP_ID }}
          RECAPTCHA_KEY: ${{ secrets.RECAPTCHA_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CRAWL4AI_API_KEY: ${{ secrets.CRAWL4AI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          JINAAI_API_KEY: ${{ secrets.JINAAI_API_KEY }}
      # Generate environment.ts
      - name: Generate environment.ts
        run: npm run prbuild
        env:
          API_KEY: ${{ secrets.API_KEY }}
          AUTH_DOMAIN: ${{ secrets.AUTH_DOMAIN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          STORAGE_BUCKET: ${{ secrets.STORAGE_BUCKET }}
          MESSAGING_SENDER_ID: ${{ secrets.MESSAGING_SENDER_ID }}
          APP_ID: ${{ secrets.APP_ID }}
          RECAPTCHA_KEY: ${{ secrets.RECAPTCHA_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CRAWL4AI_API_KEY: ${{ secrets.CRAWL4AI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          JINAAI_API_KEY: ${{ secrets.JINAAI_API_KEY }}
      # Build Angular App in production mode
      - name: Build Angular App
        env:
          API_KEY: ${{ secrets.API_KEY }}
          AUTH_DOMAIN: ${{ secrets.AUTH_DOMAIN }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          PROJECT_ID: ${{ secrets.PROJECT_ID }}
          STORAGE_BUCKET: ${{ secrets.STORAGE_BUCKET }}
          MESSAGING_SENDER_ID: ${{ secrets.MESSAGING_SENDER_ID }}
          APP_ID: ${{ secrets.APP_ID }}
          RECAPTCHA_KEY: ${{ secrets.RECAPTCHA_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CRAWL4AI_API_KEY: ${{ secrets.CRAWL4AI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          JINAAI_API_KEY: ${{ secrets.JINAAI_API_KEY }}
        run: npm run build
      - name: Install Functions Dependencies
        working-directory: ./functions
        run: npm ci
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: libnet-d76db
          channelId: live
          entryPoint: "dist/deepscrape"
          expires: "never"
      - name: Deploy Firebase Functions
        run: |
          npm install -g firebase-tools
          run: firebase deploy --only functions --project libnet-d76db
        env:
          PRODUCTION: true
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          JINAAI_API_KEY: ${{ secrets.JINAAI_API_KEY }}
          STRIPE_PUBLIC_KEY: ${{ secrets.STRIPE_PUBLIC_KEY }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          UPSTASH_REDIS_REST_URL: ${{ secrets.UPSTASH_REDIS_REST_URL }}
          UPSTASH_REDIS_REST_TOKEN: ${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
          UPSTASH_REDIS_REST_PASSWORD: ${{ secrets.UPSTASH_REDIS_REST_PASSWORD }}
          UPSTASH_REDIS_REST_USER: ${{ secrets.UPSTASH_REDIS_REST_USER }}
          API_CRAWL4AI_URL: "https://crawlagent.fly.dev"
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
